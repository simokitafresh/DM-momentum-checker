<!DOCTYPE html>
<html lang="ja">    <div class="row">
      <label>Tickers (最大5個)</label>
      <div class="tickers">ead>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>デュアルモメンタム戦略チェッカー・MVP</title>
  <style>
    body { font-family: monospace; max-width: 900px; margin: 24px auto; padding: 16px; }
    h1 { font-size: 20px; }
    form { display: grid; gap: 12px; }
    .row { display: grid; gap: 8px; grid-template-columns: 160px 1fr; align-items: center; }
    label { font-weight: bold; }
    input, select, button { padding: 8px; font-family: inherit; }
    .tickers { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
    .hint { color: #666; font-size: 12px; }
    .error { color: #c00; }
    #results { margin-top: 16px; white-space: pre-wrap; }
    .anchors { margin-top: 8px; font-size: 12px; color: #555; }
  </style>
  <link rel="icon" href="data:," />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <!-- Removed legacy HTML escape helper; using textContent for output -->
  <style>
    /* Make Saturday auto-adjust hint noticeable */
    .notice { color: #06c; }
  </style>
  <!-- no external resources to keep it single-file -->
</head>
<body>
  <h1>デュアルモメンタム戦略チェッカー</h1>

  <form id="momentum-form">
    <div class="row">
      <label>Tickers (隴崢陞滂ｽｧ5)</label>
      <div class="tickers">
        <input class="ticker-input" placeholder="AAPL" />
        <input class="ticker-input" placeholder="MSFT" />
        <input class="ticker-input" placeholder="GOOGL" />
        <input class="ticker-input" placeholder="AMZN" />
        <input class="ticker-input" placeholder="TSLA" />
      </div>
    </div>

    <div class="row">
      <label for="unit">Unit</label>
      <select id="unit">
        <option value="month">month</option>
        <option value="week">week</option>
        <option value="day">day</option>
      </select>
    </div>

    <div class="row">
      <label for="n">N (過去期間)</label>
      <input id="n" type="number" min="1" value="3" />
    </div>

    <div class="row">
      <label for="as_of_period">基準日</label>
      <div>
        <input id="as_of_period" type="month" placeholder="YYYY-MM" required />
        <div id="period-hint" class="hint">例： 2025-09</div>
      </div>
    </div>

    <div class="row">
      <div></div>
      <button type="submit">チェック</button>
    </div>
  </form>

  <div id="results"></div>

  <script>
    // --- formatMomentum: format a decimal return as signed percentage ---
    function formatMomentum(value) {
      if (value === null || value === undefined) return 'N/A';
      const num = Number(value);
      if (!Number.isFinite(num)) return 'N/A';
      const pct = Math.round(num * 10000) / 100; // two decimals
      const normalized = Object.is(pct, -0) ? 0 : pct; // avoid -0
      const sign = normalized > 0 ? '+' : (normalized < 0 ? '' : '+');
      const absStr = Math.abs(normalized).toFixed(2);
      return (normalized < 0) ? `-${absStr}%` : `${sign}${absStr}%`;
    }

    // --- getUnitJapanese: label for unit ---
    function getUnitJapanese(unit, n) {
      const unitMap = { month: 'ヶ月', week: '週間', day: '日間' };
      const label = unitMap[unit] ?? unit;
      return `${n}${label}`;
    }

    const form = document.getElementById('momentum-form');
    const unitSelect = document.getElementById('unit');
    const periodInput = document.getElementById('as_of_period');
    const periodHint = document.getElementById('period-hint');
    const resultsDiv = document.getElementById('results');

    // --- displayResults: render the response in the required format ---
    function displayResults(data, request) {
      console.log('displayResults called with:', { data, request });
      const lines = [];

      const tickers = Array.isArray(request?.tickers) ? request.tickers : [];
      for (let i = 0; i < tickers.length; i++) {
        const ticker = tickers[i];
        const result = data?.results?.[i];
        lines.push(`${ticker}: ${formatMomentum(result)}`);
      }

      lines.push('');
      const unitJa = getUnitJapanese(request?.unit, request?.n);
      const past = data?.anchors?.past;
      const current = data?.anchors?.current;
      const hasAnchors = !!past && !!current && past !== 'N/A' && current !== 'N/A';
      if (hasAnchors) {
        lines.push(`対象期間: ${unitJa} (${past} 〜 ${current})`);
      } else {
        lines.push(`対象期間: ${unitJa} (データが不足)`);
      }
      lines.push(`基準日: ${request?.as_of_period}`);

      resultsDiv.textContent = lines.join('\n');
    }

    // Update fields by unit
    function updateUnitUI() {
      const unit = unitSelect.value;
      if (unit === 'month') {
        periodInput.type = 'month';
        periodInput.placeholder = 'YYYY-MM';
        periodHint.textContent = '例： 2025-09';
      } else if (unit === 'week') {
        periodInput.type = 'date';
        periodInput.placeholder = 'YYYY-MM-DD (土曜日)';
        periodInput.step = '7';
        periodHint.textContent = '週間ベースは土曜日に設定してください';
      } else { // day
        periodInput.type = 'date';
        periodInput.placeholder = 'YYYY-MM-DD';
        periodInput.step = '1';
        periodHint.textContent = '例： 2025-09-08';
      }
    }
    unitSelect.addEventListener('change', updateUnitUI);
    updateUnitUI();

    // Auto-adjust to Saturday when unit=week
    periodInput.addEventListener('change', function () {
      if (unitSelect.value !== 'week' || !this.value) return;
      const dt = new Date(this.value);
      const dow = dt.getDay();
      if (dow !== 6) { // not Saturday
        const daysUntilSaturday = (6 - dow + 7) % 7 || 7;
        dt.setDate(dt.getDate() + daysUntilSaturday);
        const y = dt.getFullYear();
        const m = String(dt.getMonth() + 1).padStart(2, '0');
        const d = String(dt.getDate()).padStart(2, '0');
        this.value = `${y}-${m}-${d}`;
        periodHint.textContent = '週間ベースの基準日は土曜日に自動調整されました';
        periodHint.classList.add('notice');
        setTimeout(() => {
          periodHint.textContent = '週間ベースは土曜日に設定してください';
          periodHint.classList.remove('notice');
        }, 2000);
      }
    });

    // Submit handler
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      resultsDiv.textContent = '';

      const tickers = Array.from(document.querySelectorAll('.ticker-input'))
        .map(i => i.value.trim().toUpperCase())
        .filter(Boolean);
      if (tickers.length === 0) {
        resultsDiv.textContent = 'エラー: チッカーを1つ以上入力してください';
        return;
      }

      const unit = unitSelect.value;
      const n = parseInt(document.getElementById('n').value, 10);
      const asOf = periodInput.value;

      const payload = { tickers, unit, n, as_of_period: asOf };

      resultsDiv.textContent = 'チェック中...';
      try {
        const res = await fetch('/compute', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();

        // Render results with helpers
        displayResults(data, payload);
      } catch (error) {
        console.error(error);
        const msg = (error && error.message) ? error.message : String(error);
        resultsDiv.textContent = `エラー: ${msg}`;
      }
    });
  </script>
</body>
</html>
